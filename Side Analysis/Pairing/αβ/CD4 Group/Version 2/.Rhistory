mean_RCD1 <- rowMeans(count_matrix[, RCD1_samples, drop = FALSE])
log2fc <- log2( (mean_ACD + 1) / (mean_RCD1 + 1) )
count_matrix$log2FC <- log2fc
pvals <- apply(count_matrix[, c(ACD_samples, RCD1_samples), drop = FALSE], 1, function(x) {
ACD_values <- as.numeric(x[ACD_samples])
RCD1_values <- as.numeric(x[RCD1_samples])
if(length(ACD_values) < 2 || length(RCD1_values) < 2) {
return(NA)
}
test <- wilcox.test(ACD_values, RCD1_values)
return(test$p.value)
})
count_matrix$pvalue <- pvals
count_matrix <- count_matrix[!is.na(count_matrix$pvalue), ]
count_matrix$FDR <- p.adjust(count_matrix$pvalue, method = "BH")
count_matrix$negLog10P <- -log10(count_matrix$pvalue)
top_genes <- head(count_matrix[order(count_matrix$pvalue), ], 2)
top_names <- rownames(top_genes)
colors <- c("#FABEBE", "#808080", "green", "purple", "orange")
png("volcano_plot_pvalue_top5_legend_outside.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PNG
png("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PDF
pdf("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.pdf", width = 6, height = 7)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
setwd("C:/Esmaeil/CeliacProject/CeliacProject/TCR genotype distribution/TCR genotype distribution (Part 10)/wilcoxon/IEL/TRBV/3_ACD and RCD1")
clean_data <- full_metadata[
!is.na(full_metadata$TRBV) &
!is.na(full_metadata$Patient) &
full_metadata$cluster %in% c("IEL GZMK+", "Trm IEL", "Prolif. IEL", "Cyt. IEL", "IEL CCL4+", "nIEL", "CD8 Cyt.") &
full_metadata$Diagnosis %in% c("ACD", "RCD-I"),
]
count_matrix <- as.data.frame.matrix(table(clean_data$TRBV, clean_data$Patient))
percent_matrix <- sweep(count_matrix, 2, colSums(count_matrix), FUN = "/") * 100
count_matrix = percent_matrix
ACD_samples <- colnames(count_matrix)[colnames(count_matrix) %in% unique(clean_data$Patient[clean_data$Diagnosis == "ACD"])]
RCD1_samples <- colnames(count_matrix)[colnames(count_matrix) %in% unique(clean_data$Patient[clean_data$Diagnosis == "RCD-I"])]
mean_ACD <- rowMeans(count_matrix[, ACD_samples, drop = FALSE])
mean_RCD1 <- rowMeans(count_matrix[, RCD1_samples, drop = FALSE])
log2fc <- log2( (mean_ACD + 1) / (mean_RCD1 + 1) )
count_matrix$log2FC <- log2fc
pvals <- apply(count_matrix[, c(ACD_samples, RCD1_samples), drop = FALSE], 1, function(x) {
ACD_values <- as.numeric(x[ACD_samples])
RCD1_values <- as.numeric(x[RCD1_samples])
if(length(ACD_values) < 2 || length(RCD1_values) < 2) {
return(NA)
}
test <- wilcox.test(ACD_values, RCD1_values)
return(test$p.value)
})
count_matrix$pvalue <- pvals
count_matrix <- count_matrix[!is.na(count_matrix$pvalue), ]
count_matrix$FDR <- p.adjust(count_matrix$pvalue, method = "BH")
count_matrix$negLog10P <- -log10(count_matrix$pvalue)
top_genes <- head(count_matrix[order(count_matrix$pvalue), ], 3)
top_names <- rownames(top_genes)
colors <- c("#FABEBE", "#808080", "green", "purple", "orange")
png("volcano_plot_pvalue_top5_legend_outside.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PNG
png("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PDF
pdf("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.pdf", width = 6, height = 7)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
setwd("C:/Esmaeil/CeliacProject/CeliacProject/TCR genotype distribution/TCR genotype distribution (Part 10)/wilcoxon/IEL/TRBV/3_ACD and RCD1")
clean_data <- full_metadata[
!is.na(full_metadata$TRBV) &
!is.na(full_metadata$Patient) &
full_metadata$cluster %in% c("IEL GZMK+", "Trm IEL", "Prolif. IEL", "Cyt. IEL", "IEL CCL4+", "nIEL", "CD8 Cyt.") &
full_metadata$Diagnosis %in% c("ACD", "RCD-I"),
]
count_matrix <- as.data.frame.matrix(table(clean_data$TRBV, clean_data$Patient))
percent_matrix <- sweep(count_matrix, 2, colSums(count_matrix), FUN = "/") * 100
count_matrix = percent_matrix
ACD_samples <- colnames(count_matrix)[colnames(count_matrix) %in% unique(clean_data$Patient[clean_data$Diagnosis == "ACD"])]
RCD1_samples <- colnames(count_matrix)[colnames(count_matrix) %in% unique(clean_data$Patient[clean_data$Diagnosis == "RCD-I"])]
mean_ACD <- rowMeans(count_matrix[, ACD_samples, drop = FALSE])
mean_RCD1 <- rowMeans(count_matrix[, RCD1_samples, drop = FALSE])
log2fc <- log2( (mean_ACD + 1) / (mean_RCD1 + 1) )
count_matrix$log2FC <- log2fc
pvals <- apply(count_matrix[, c(ACD_samples, RCD1_samples), drop = FALSE], 1, function(x) {
ACD_values <- as.numeric(x[ACD_samples])
RCD1_values <- as.numeric(x[RCD1_samples])
if(length(ACD_values) < 2 || length(RCD1_values) < 2) {
return(NA)
}
test <- wilcox.test(ACD_values, RCD1_values)
return(test$p.value)
})
count_matrix$pvalue <- pvals
count_matrix <- count_matrix[!is.na(count_matrix$pvalue), ]
count_matrix$FDR <- p.adjust(count_matrix$pvalue, method = "BH")
count_matrix$negLog10P <- -log10(count_matrix$pvalue)
top_genes <- head(count_matrix[order(count_matrix$pvalue), ], 3)
top_names <- rownames(top_genes)
colors <- c("#FABEBE", "#808080", "#AaCcEe", "purple", "orange")
png("volcano_plot_pvalue_top5_legend_outside.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PNG
png("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.png", width = 1300, height = 1600, res = 300)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
# Save as PDF
pdf("volcano_plot_pvalue_top5_TRBV_ACD_vs_RCD1.pdf", width = 6, height = 7)
plot(
count_matrix$log2FC,
count_matrix$negLog10P,
xlab = "% difference TRBV gene use(ACD versus RCD1)",
ylab = "-log10(p-value)",
pch = 20,
col = "black",
xlim = range(count_matrix$log2FC) + c(0, 4)
)
abline(h = 1.3, lty = 2, col = "gray40")
abline(v = 0, lty = 2, col = "gray40")
title(main = "Volcano plot of TRBV segment usage", line = 2, adj = 0.5)
for (i in seq_along(top_names)) {
gene <- top_names[i]
points(
count_matrix[gene, "log2FC"],
count_matrix[gene, "negLog10P"],
pch = 20,
col = colors[i],
cex = 1.5
)
}
par(xpd = TRUE)
legend(
x = max(count_matrix$log2FC) + 1.5, y = max(count_matrix$negLog10P),
legend = top_names,
col = colors,
pch = 20,
cex = 1,
title = "Top Genes"
)
dev.off()
load("C:/Esmaeil/CeliacProject/BackUp/Meta Data/MetaData_Esmaeil.Rdata")
setwd("C:/Esmaeil/CeliacProject/CeliacProject/TRDV and TRGV Pair/alph-beta/CD4 Group/Version 2")
library(dplyr)
library(circlize)
library(ggplot2)
library(ggalluvial)
library(scales)
library(tidyr)
library(writexl)
full_metadata = full_metadata[full_metadata$cluster == "Th" |
full_metadata$cluster == "Tregs" |
full_metadata$cluster == "Th17" |
full_metadata$cluster == "Th2/Tfh" |
full_metadata$cluster == "Th1 Mem", ]
full_metadata = full_metadata[full_metadata$TRAV == "TRAV12-1" |
full_metadata$TRAV == "TRAV30" |
full_metadata$TRAV == "TRAV12-2" |
full_metadata$TRAV == "TRAV8-4" |
full_metadata$TRAV == "TRAV8-6", ]
full_metadata <- full_metadata %>% filter( !is.na(full_metadata$TRAV) & !is.na(full_metadata$TRBV) )
result <- full_metadata %>%
group_by(Diagnosis, TRAV) %>%
summarise(TRBVs = paste(unique(TRBV), collapse = ","), .groups = "drop") %>%
arrange(Diagnosis, TRAV)
all_sectors <- unique(c(full_metadata$TRAV, full_metadata$TRBV))
all_sectors <- na.omit(all_sectors)
# Example: define your own colors
custom_colors <- c(
"TRAV12-1"  = "#4D648D",
"TRAV30"  = "#FDEE00",
"TRAV12-2"  = "#997A8D",
"TRAV8-4"  = "#FB4D46",
"TRAV8-6"  = "#2F847C"
)
# Assign any sectors not listed above to grey
grid.col <- setNames(rep("grey", length(all_sectors)), all_sectors)
grid.col[names(custom_colors)] <- custom_colors
TRAV_order <- sort(unique(na.omit(full_metadata$TRAV)))
other_sectors <- setdiff(unique(c(full_metadata$TRAV, full_metadata$TRBV)), TRAV_order)
sector_order <- c(TRAV_order, other_sectors)
# chordDiagram
Diagnosiss <- unique(full_metadata$Diagnosis)
Diagnosiss <- unique(full_metadata$Diagnosis)
for (p in Diagnosiss) {
df <- subset(full_metadata, Diagnosis == p, select = c("TRAV", "TRBV"))
df <- na.omit(df)
if (nrow(df) > 0) {
## --- PDF output ---
pdf(file = paste0("Circos_", p, ".pdf"), width = 9, height = 11)
circos.par(canvas.ylim = c(-0.8, 1))   # shift circle down
chordDiagram(df,
order = sector_order,
transparency = 0.5,
annotationTrack = "grid",
preAllocateTracks = list(track.height = 0.1),
grid.col = grid.col)
title(main = paste("TRAV-TRBV pairing - CD4 Clusters -", p), line = 0.3, cex.main = 0.9)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
sector.name = get.cell.meta.data("sector.index")
# اندازه فونت بر اساس TRAV یا TRBV
fontsize <- ifelse(grepl("^TRBV", sector.name), 0.5, 0.8) #TRBV: 0.5 and TRAV: 0.8
circos.text(CELL_META$xcenter, CELL_META$ylim[1], sector.name,
facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5),
cex = fontsize)
},bg.border = NA)
dev.off()
circos.clear()
## --- PNG output ---
png(file = paste0("Circos_", p, ".png"), width = 2300, height = 2400, res = 300)
circos.par(canvas.ylim = c(-0.95, 1))   # shift circle down
chordDiagram(df,
order = sector_order,
transparency = 0.5,
annotationTrack = "grid",
preAllocateTracks = list(track.height = 0.1),
grid.col = grid.col)
title(main = paste("TRAV-TRBV pairing - CD4 Clusters -", p), line = 0.3, cex.main = 0.9)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
sector.name = get.cell.meta.data("sector.index")
fontsize <- ifelse(grepl("^TRBV", sector.name), 0.5, 0.8)
circos.text(CELL_META$xcenter, CELL_META$ylim[1], sector.name,
facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5),
cex = fontsize)
}, bg.border = NA)
dev.off()
circos.clear()
}
}
# alluvial plot TRAV
diagnosis_summary <- full_metadata %>%
group_by(Diagnosis, TRAV) %>%
summarise(count = n(), .groups = "drop_last") %>%
mutate(total = sum(count),
percent = round(100 * count / total, 2)) %>%
ungroup() %>%
arrange(Diagnosis, TRAV)
alluvial_data <- diagnosis_summary %>%
mutate(Diagnosis = factor(Diagnosis),
TRAV = factor(TRAV)) %>%
rename(Stage = Diagnosis, id = TRAV, Freq = percent) %>%
mutate(alluvium = id)  # Needed for geom_flow
TRAV_colors <- c(
"TRAV12-1"  = "#4D648D",
"TRAV30"  = "#FDEE00",
"TRAV12-2"  = "#997A8D",
"TRAV8-4"  = "#FB4D46",
"TRAV8-6"  = "#2F847C"
)
p <- ggplot(alluvial_data,
aes(x = Stage, stratum = id, alluvium = alluvium,
y = Freq, fill = id)) +
geom_flow(alpha = 0.7, color = "grey50") +
geom_stratum(width = 0.3, color = "black") +
geom_text(stat = "stratum", aes(label = paste0(round(Freq, 1), "%")),
size = 3, color = "black") +
scale_x_discrete(expand = c(0.1, 0.1)) +
scale_fill_manual(values = TRAV_colors) +
scale_y_continuous(labels = percent_format(scale = 1)) +
labs(title = "Proportion of TRAV Types per Diagnosis - All Tgd Clusters",
x = "Diagnosis",
y = "Percentage (%)") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(hjust = 0.5))
# Save as PNG
ggsave("TRAV_alluvial_percentages.png", plot = p, width = 10, height = 5, dpi = 600, bg = "white")
ggsave("TRAV_alluvial_percentages.pdf", plot = p, width = 10, height = 5, dpi = 300, bg = "white")
